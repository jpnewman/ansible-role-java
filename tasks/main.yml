- name: Load platform-specific variable file, if present
  include_vars: "{{ item }}"
  with_first_found:
    - "{{ ansible_distribution }}.yml"

- name: Add java repo
  apt_repository:
    repo: "{{ apt_java_repo }}"
    state: present
    update_cache: yes
  when: install_java and apt_java_codename is undefined

- name: Add java repo with explicit codename supplied
  apt_repository:
    repo: "{{ apt_java_repo }}"
    codename: "{{ apt_java_codename }}"
    state: present
    update_cache: yes
  when: install_java and apt_java_codename is defined

- name: Accept Oracle license prior JDK installation (select)
  debconf: name={{ apt_java_package }} question='shared/accepted-oracle-license-v1-1' value='true' vtype='select'
  when: install_java
  ignore_errors: "{{ ansible_check_mode }}"

- name: Accept Oracle license prior JDK installation (seen)
  debconf: name={{ apt_java_package }} question='shared/accepted-oracle-license-v1-1' value='true' vtype='seen'
  when: install_java
  ignore_errors: "{{ ansible_check_mode }}"

- name: Install Java
  apt: name={{ apt_java_package }} state=present update_cache=yes cache_valid_time={{ apt_cache_valid_time }}
  when: install_java
  ignore_errors: "{{ ansible_check_mode }}"

- name: Update Java security
  lineinfile:
    dest: "/etc/java-8-oracle/security/java.policy"
    regexp: "{{ item | regex_escape() }}"
    line: "        {{ item }}"
    insertbefore: "};"
  with_items: "{{ java_security_policies }}"
